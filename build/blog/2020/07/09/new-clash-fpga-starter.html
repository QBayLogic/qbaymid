<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>New Clash FPGA Starter</title>
  <meta property="og:title" content="QBayLogic">
  <meta property="og:description" content="QBayLogic is a spin-off company of the University of Twente, Enschede, The Netherlands. We apply FPGA technology in domains with difficult mathematical problems.">
  <meta name="twitter:card" content="summary">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="../../../../stylesheets/site-bff400c6.css" rel="stylesheet" />
  <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.4.7/webfont.js"></script>
  <script>
    WebFont.load({
      google: {
        families: ["Lato:100,100italic,300,300italic,400,400italic,700,700italic,900,900italic","Montserrat:400,700","Cardo:regular,italic,700","Reenie Beanie:regular"]
      }
    });
  </script>
  <script src="../../../../javascripts/modernizr-05933cc1.js"></script>
  <link rel="shortcut icon" type="image/x-icon" href="../../../../images/logo_ico_small-ba7e953f.png">
  <link rel="apple-touch-icon" href="../../../../images/Logo-389f0112.png">
</head>
<body>
  <div class="w-section header-wrapper">
    <div class="top-header">
      <div class="w-container container">
        <div class="top-nav-content-block social">
          <a href="http://www.facebook.com/qbaylogic" target="_blank" class="w-inline-block top-social-block"><img src="../../../../images/facebook_white-61c83ff3.svg" class="top-social-icon" alt="" />
          </a>
          <a href="http://www.twitter.com/qbaylogic" target="_blank" class="w-inline-block top-social-block"><img src="../../../../images/twitter_white-2b2bd36d.svg" class="top-social-icon" alt="" />
          </a>
          <a href="http://www.linkedin.com/company/qbaylogic" target="_blank" class="w-inline-block top-social-block"><img src="../../../../images/linkedin-logo_white-c0d672b6.svg" class="top-social-icon" alt="" />
          </a>
        </div>
        <div class="top-nav-content-block">
          <a href="http://qbaylogic.com" class="w-inline-block w-clearfix"><img src="../../../../images/gb-5afd0a44.png" class="top-nav-icon" alt="" />
          </a>
          <a href="http://qbaylogic.nl" class="w-inline-block w-clearfix"><img src="../../../../images/nl-5f381ef4.png" class="top-nav-icon" alt="" />
          </a>
        </div>
        <div class="w-hidden-small w-hidden-tiny top-nav-content-block left">
          <div class="header-contact-text">We are an FPGA design house located in Enschede, The Netherlands.</div>
        </div>
      </div>
    </div>
    <div class="contact-header">
      <div class="w-container container">
        <a href="/index.html" class="w-nav-brand logo-container"><img src="../../../../images/Logo-109_new-ok-e0a01a25.png" class="logo" alt="" />
        </a>
        <div class="w-clearfix w-hidden-small w-hidden-tiny header-contact-block"><img src="../../../../images/phone-auricular-outline_grey-93d2e4ef.svg" class="header-contact-icon" alt="" />
          <div class="header-contact-title">Call us on:</div>
          <div class="header-contact-title _2"><a wf-temp-elem="" class="link header-contact-link" href="tel:+31858000380">+31 (0)85 8000 380</a>
          </div>
        </div>
        <div class="w-clearfix w-hidden-small w-hidden-tiny header-contact-block"><img src="../../../../images/email-envelope-outline_grey-1b7eac57.svg" class="header-contact-icon" alt="" />
          <div class="w-hidden-small w-hidden-tiny header-contact-title">Questions?</div>
          <div class="header-contact-title _2"><a class="link header-contact-link" href="mailto:info@qbaylogic.com">Send us an e-mail</a>
          </div>
        </div>
      </div>
    </div>
    <div data-collapse="small" data-animation="default" data-duration="400" data-contain="1" class="w-nav navbar">
      <div class="w-container nav-container">
        <nav role="navigation" class="w-nav-menu nav-menu"><a href="/" class="w-nav-link nav-link">Home</a>
          <div data-delay="400" class="w-dropdown dropdown-link">
            <div class="w-dropdown-toggle nav-link dropdown">
              <div>Our services</div>
              <div class="w-icon-dropdown-toggle dropdown-icon"></div>
            </div>
            <nav data-ix="dropdown-list" class="w-dropdown-list dropdown-list"><a href="/fpga-design.html" class="w-dropdown-link dropdown-link-item">FPGA design</a><a href="/workshops-training.html" class="w-dropdown-link dropdown-link-item">Workshops &amp; Training</a><a href="/clash-support.html" class="w-dropdown-link dropdown-link-item">Clash support</a>
            </nav>
          </div>
          <div data-delay="200" class="w-dropdown dropdown-link">
            <div class="w-dropdown-toggle nav-link dropdown">
              <div>About us</div>
              <div class="w-icon-dropdown-toggle dropdown-icon"></div>
            </div>
            <nav data-ix="dropdown-list" class="w-dropdown-list dropdown-list"><a href="/about-clash.html" class="w-dropdown-link dropdown-link-item">About Clash</a><a href="/our-team.html" class="w-dropdown-link dropdown-link-item">Our team</a>
            </nav>
          </div><a href="/blog.html" class="w-nav-link nav-link">Blog archive</a><a href="/testimonials.html" class="w-nav-link nav-link">Projects &amp; Testimonials</a><a href="/contact-us.html" class="w-nav-link nav-link">Contact us</a>
        </nav>
        <div class="w-nav-button menu-button">
          <div class="w-icon-nav-menu"></div>
        </div>
      </div>
    </div>
  </div>


  <div class="w-section section tint">
  <div class="w-container">
    <div class="w-row recent-news-row">
      <div class="w-col w-col-9 overall-content-column-left">
        <div class="blog-post">
          <div class="blog-post-header-image-block" style="background: url('../../../../images/fpga_2_400x400_orange-6fac7130.jpg'); background-size: 100% 280px "></div>
          <h1 class="blog-post-title">New Clash FPGA Starter</h1>
          <div class="blog-post-date">Jul  9, 2020</div>
          <div class="w-richtext">
            <p><strong>This is an updated version of our <a href="">old tutorial</a></strong></p>

<p>For this tutorial you will need at least <a href="https://clash-lang.org/install/">Clash version 1.2.3</a>.
In this tutorial we'll be programming the Terasic <a href="http://www.terasic.com.tw/cgi-bin/page/archive.pl?Language=English&amp;CategoryNo=165&amp;No=593&amp;PartNo=1">DE0-Nano</a> FPGA development board using the functional hardware description language <a href="http://www.clash-lang.org">Clash</a>.
The end result of this tutorial is demonstrated in the video below:</p>

<figure class="w-richtext-align-fullwidth" style="padding-bottom: 56.2061%; width: 100%; max-width: 100%;" data-rt-max-width="" data-rt-max-height="56.206088992974244%" data-page-url="https://youtu.be/XUj9cewMsww" data-rt-type="video" data-rt-dimensions="854:480" data-rt-align="fullwidth">
<div>
  <iframe src="https://www.youtube.com/embed/XUj9cewMsww" frameborder="0" scrolling="no" allowfullscreen=""></iframe>
</div>&nbsp;</figure>

<p>This tutorial is not a general introduction to Clash, nor to programming FPGAs.
It is meant to demonstrate how to use of <a href="https://hackage.haskell.org/package/clash-prelude/docs/Clash-Annotations-TopEntity.html"><code>Synthesize</code></a> annotations and <a href="http://hackage.haskell.org/package/clash-prelude/docs/Clash-Annotations-SynthesisAttributes.html"><code>SynthesisAttributes</code></a> to configure your Clash designs for an FPGA, without writing a single line of VHDL or (System)Verilog.</p>

<h3 id="blinker-circuit">Blinker circuit</h3>

<p>We start with some general information about the <a href="http://www.terasic.com.tw/cgi-bin/page/archive.pl?Language=English&amp;CategoryNo=165&amp;No=593&amp;PartNo=1">DE0-Nano</a> board:</p>

<ul>
  <li>It has a 50 MHz crystal connected to a clock pin of FPGA, which we will connect to one of the <a href="https://www.altera.com/literature/ug/ug_altpll.pdf">PLL</a>s that is on the FPGA to create a <em>stable</em> 20 MHz clock signal.</li>
  <li>It has 8 green LEDs that that are <em>active-high</em> (turn on at logic level <code>1</code>).</li>
  <li>It has two buttons which are already properly <a href="http://en.wikipedia.org/wiki/Switch#Contact_bounce">debounced</a> by a Schmitt trigger. The buttons are <em>active-low</em>, meaning that their logic level is <code>0</code> when they are pressed, and logic level <code>1</code> when they are not pressed.</li>
</ul>

<p>The circuit that we are making will repeatedly do one of two things:</p>

<ul>
  <li>Invert the state of the LEDs</li>
  <li>Rotate the state of the LEDs</li>
</ul>

<p>We switch between these two modes when the <code>KEY1</code> button on the board is pressed <em>and subsequently released</em>.
We reset the circuit by pressing the <code>KEY0</code> button.</p>

<h3 id="clash-circuit-specification">Clash circuit specification</h3>

<p>The complete description of the circuit is given below, where description of the core behavior of the circuit only starts at <a href="#line-95">line 95</a>, and everything that comes before it is there to correctly set up the FPGA.</p>

<div class="codehilite"><pre><span></span><a name="line-1"></a><span class="kr">module</span> <span class="nn">Blinker</span> <span class="kr">where</span>
<a name="line-2"></a>
<a name="line-3"></a><span class="kr">import</span> <span class="nn">Clash.Prelude</span>
<a name="line-4"></a><span class="kr">import</span> <span class="nn">Clash.Intel.ClockGen</span>
<a name="line-5"></a><span class="kr">import</span> <span class="nn">Clash.Annotations.SynthesisAttributes</span>
<a name="line-6"></a>
<a name="line-7"></a><span class="c1">-- Define a synthesis domain with a clock with a period of 20000 /ps/.</span>
<a name="line-8"></a><span class="c1">-- i.e. 50 MHz</span>
<a name="line-9"></a><span class="nf">createDomain</span> <span class="n">vSystem</span><span class="p">{</span><span class="n">vName</span><span class="ow">=</span><span class="s">&quot;Input&quot;</span><span class="p">,</span> <span class="n">vPeriod</span><span class="ow">=</span><span class="mi">20000</span><span class="p">}</span>
<a name="line-10"></a>
<a name="line-11"></a><span class="c1">-- Define a synthesis domain with a clock with a period of 50000 /ps/.</span>
<a name="line-12"></a><span class="c1">-- i.e. 20 MHz</span>
<a name="line-13"></a><span class="nf">createDomain</span> <span class="n">vSystem</span><span class="p">{</span><span class="n">vName</span><span class="ow">=</span><span class="s">&quot;Dom20MHz&quot;</span><span class="p">,</span> <span class="n">vPeriod</span><span class="ow">=</span><span class="mi">50000</span><span class="p">}</span>
<a name="line-14"></a>
<a name="line-15"></a><span class="cm">{-# ANN topEntity</span>
<a name="line-16"></a><span class="cm">  (Synthesize</span>
<a name="line-17"></a><span class="cm">    { t_name   = &quot;blinker&quot;</span>
<a name="line-18"></a><span class="cm">    , t_inputs = [ PortName &quot;CLOCK_50&quot;</span>
<a name="line-19"></a><span class="cm">                 , PortName &quot;KEY0&quot;</span>
<a name="line-20"></a><span class="cm">                 , PortName &quot;KEY1&quot;</span>
<a name="line-21"></a><span class="cm">                 ]</span>
<a name="line-22"></a><span class="cm">    , t_output = PortName &quot;LED&quot;</span>
<a name="line-23"></a><span class="cm">    }) #-}</span>
<a name="line-24"></a><span class="nf">topEntity</span> <span class="ow">::</span>
<a name="line-25"></a>  <span class="c1">-- | Incoming clock</span>
<a name="line-26"></a>  <span class="c1">--</span>
<a name="line-27"></a>  <span class="c1">-- Annotate with attributes to map the argument to the correct pin,</span>
<a name="line-28"></a>  <span class="c1">-- with the correct voltage settings, on the DE0-Nano development kit.</span>
<a name="line-29"></a>  <span class="kt">Clock</span> <span class="kt">Input</span>
<a name="line-30"></a>    <span class="p">`</span><span class="kt">Annotate</span><span class="p">`</span> <span class="kt">&#39;StringAttr</span> <span class="s">&quot;chip_pin&quot;</span> <span class="s">&quot;R8&quot;</span>
<a name="line-31"></a>    <span class="p">`</span><span class="kt">Annotate</span><span class="p">`</span> <span class="kt">&#39;StringAttr</span>
<a name="line-32"></a>                <span class="s">&quot;altera_attribute&quot;</span> <span class="s">&quot;-name IO_STANDARD </span><span class="se">\&quot;</span><span class="s">3.3-V LVTTL</span><span class="se">\&quot;</span><span class="s">&quot;</span> <span class="ow">-&gt;</span>
<a name="line-33"></a>  <span class="c1">-- | Reset signal, straight from KEY0</span>
<a name="line-34"></a>  <span class="kt">Signal</span> <span class="kt">Input</span> <span class="kt">Bool</span>
<a name="line-35"></a>    <span class="p">`</span><span class="kt">Annotate</span><span class="p">`</span> <span class="kt">&#39;StringAttr</span> <span class="s">&quot;chip_pin&quot;</span> <span class="s">&quot;J15&quot;</span>
<a name="line-36"></a>    <span class="p">`</span><span class="kt">Annotate</span><span class="p">`</span> <span class="kt">&#39;StringAttr</span>
<a name="line-37"></a>                <span class="s">&quot;altera_attribute&quot;</span> <span class="s">&quot;-name IO_STANDARD </span><span class="se">\&quot;</span><span class="s">3.3-V LVTTL</span><span class="se">\&quot;</span><span class="s">&quot;</span> <span class="ow">-&gt;</span>
<a name="line-38"></a>  <span class="c1">-- | Mode choice, straight from KEY1. See &#39;LedMode&#39;.</span>
<a name="line-39"></a>  <span class="kt">Signal</span> <span class="kt">Dom20MHz</span> <span class="kt">Bit</span>
<a name="line-40"></a>    <span class="p">`</span><span class="kt">Annotate</span><span class="p">`</span> <span class="kt">&#39;StringAttr</span> <span class="s">&quot;chip_pin&quot;</span> <span class="s">&quot;E1&quot;</span>
<a name="line-41"></a>    <span class="p">`</span><span class="kt">Annotate</span><span class="p">`</span> <span class="kt">&#39;StringAttr</span>
<a name="line-42"></a>                <span class="s">&quot;altera_attribute&quot;</span> <span class="s">&quot;-name IO_STANDARD </span><span class="se">\&quot;</span><span class="s">3.3-V LVTTL</span><span class="se">\&quot;</span><span class="s">&quot;</span> <span class="ow">-&gt;</span>
<a name="line-43"></a>  <span class="c1">-- | Output containing 8 bits, corresponding to 8 LEDs</span>
<a name="line-44"></a>  <span class="c1">--</span>
<a name="line-45"></a>  <span class="c1">-- Use comma-seperated list in the &quot;chip_pin&quot; attribute to maps the</span>
<a name="line-46"></a>  <span class="c1">-- individual bits of the result to the correct pins on the DE0-Nano</span>
<a name="line-47"></a>  <span class="c1">-- development kit</span>
<a name="line-48"></a>  <span class="kt">Signal</span> <span class="kt">Dom20MHz</span> <span class="p">(</span><span class="kt">BitVector</span> <span class="mi">8</span><span class="p">)</span>
<a name="line-49"></a>    <span class="p">`</span><span class="kt">Annotate</span><span class="p">`</span> <span class="kt">&#39;StringAttr</span>
<a name="line-50"></a>                <span class="s">&quot;chip_pin&quot;</span> <span class="s">&quot;L3, B1, F3, D1, A11, B13, A13, A15&quot;</span>
<a name="line-51"></a>    <span class="p">`</span><span class="kt">Annotate</span><span class="p">`</span> <span class="kt">&#39;StringAttr</span>
<a name="line-52"></a>                <span class="s">&quot;altera_attribute&quot;</span> <span class="s">&quot;-name IO_STANDARD </span><span class="se">\&quot;</span><span class="s">3.3-V LVTTL</span><span class="se">\&quot;</span><span class="s">&quot;</span>
<a name="line-53"></a><span class="nf">topEntity</span> <span class="n">clk50Mhz</span> <span class="n">rstBtn</span> <span class="n">modeBtn</span> <span class="ow">=</span>
<a name="line-54"></a>  <span class="c1">-- Connect our clock, reset, and enable lines to the corresponding</span>
<a name="line-55"></a>  <span class="c1">-- /implicit/ arguments of the &#39;mealy&#39; and &#39;isRising&#39; function.</span>
<a name="line-56"></a>  <span class="n">exposeClockResetEnable</span>
<a name="line-57"></a>    <span class="p">(</span><span class="n">mealy</span> <span class="n">blinkerT</span> <span class="n">initialStateBlinkerT</span> <span class="o">.</span> <span class="n">isRising</span> <span class="mi">1</span><span class="p">)</span>
<a name="line-58"></a>    <span class="n">clk20Mhz</span>
<a name="line-59"></a>    <span class="n">rstSync</span>
<a name="line-60"></a>    <span class="n">en</span>
<a name="line-61"></a>    <span class="n">modeBtn</span>
<a name="line-62"></a>  <span class="kr">where</span>
<a name="line-63"></a>  <span class="c1">-- Enable line for subcomponents: we&#39;ll keep it always running</span>
<a name="line-64"></a>  <span class="n">en</span> <span class="ow">=</span> <span class="n">enableGen</span>
<a name="line-65"></a>
<a name="line-66"></a>  <span class="c1">-- Start with the first LED turned on, in rotate mode, with the counter</span>
<a name="line-67"></a>  <span class="c1">-- on zero</span>
<a name="line-68"></a>  <span class="n">initialStateBlinkerT</span> <span class="ow">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kt">Rotate</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a name="line-69"></a>
<a name="line-70"></a>  <span class="c1">-- Signal coming from the reset button is low when pressed, and high when</span>
<a name="line-71"></a>  <span class="c1">-- not pressed. We convert this signal to the polarity of our domain with</span>
<a name="line-72"></a>  <span class="c1">-- &#39;unsafeFromActiveLow&#39;.</span>
<a name="line-73"></a>  <span class="n">rst</span> <span class="ow">=</span> <span class="n">unsafeFromLowPolarity</span> <span class="n">rstBtn</span>
<a name="line-74"></a>
<a name="line-75"></a>  <span class="c1">-- Instantiate a PLL: this stabilizes the incoming clock signal and</span>
<a name="line-76"></a>  <span class="c1">-- indicates when the signal is stable. We&#39;re also using it to transform</span>
<a name="line-77"></a>  <span class="c1">-- an incoming clock signal running at 50 MHz to a clock signal running at</span>
<a name="line-78"></a>  <span class="c1">-- 20 MHz.</span>
<a name="line-79"></a>  <span class="p">(</span><span class="n">clk20Mhz</span><span class="p">,</span> <span class="n">pllStable</span><span class="p">)</span> <span class="ow">=</span>
<a name="line-80"></a>    <span class="n">altpll</span>
<a name="line-81"></a>      <span class="o">@</span><span class="kt">Dom20MHz</span>
<a name="line-82"></a>      <span class="p">(</span><span class="kt">SSymbol</span> <span class="o">@</span><span class="s">&quot;altpll20&quot;</span><span class="p">)</span>
<a name="line-83"></a>      <span class="n">clk50Mhz</span>
<a name="line-84"></a>      <span class="n">rst</span>
<a name="line-85"></a>
<a name="line-86"></a>  <span class="c1">-- Synchronize reset to clock signal coming from PLL. We want the reset to</span>
<a name="line-87"></a>  <span class="c1">-- remain active while the PLL is NOT stable, hence the conversion with</span>
<a name="line-88"></a>  <span class="c1">-- &#39;unsafeFromActiveLow&#39;</span>
<a name="line-89"></a>  <span class="n">rstSync</span> <span class="ow">=</span>
<a name="line-90"></a>    <span class="n">resetSynchronizer</span>
<a name="line-91"></a>      <span class="n">clk20Mhz</span>
<a name="line-92"></a>      <span class="p">(</span><span class="n">unsafeFromLowPolarity</span> <span class="n">pllStable</span><span class="p">)</span>
<a name="line-93"></a>      <span class="n">en</span>
<a name="line-94"></a>
<a name="line-95"></a><span class="kr">data</span> <span class="kt">LedMode</span>
<a name="line-96"></a>  <span class="c1">-- | After some period, rotate active led to the left</span>
<a name="line-97"></a>  <span class="ow">=</span> <span class="kt">Rotate</span>
<a name="line-98"></a>  <span class="c1">-- | After some period, turn on all disable LEDs, and vice versa</span>
<a name="line-99"></a>  <span class="o">|</span> <span class="kt">Complement</span>
<a name="line-100"></a>  <span class="kr">deriving</span> <span class="p">(</span><span class="kt">Generic</span><span class="p">,</span> <span class="kt">NFDataX</span><span class="p">)</span>
<a name="line-101"></a>
<a name="line-102"></a><span class="nf">flipMode</span> <span class="ow">::</span> <span class="kt">LedMode</span> <span class="ow">-&gt;</span> <span class="kt">LedMode</span>
<a name="line-103"></a><span class="nf">flipMode</span> <span class="kt">Rotate</span> <span class="ow">=</span> <span class="kt">Complement</span>
<a name="line-104"></a><span class="nf">flipMode</span> <span class="kt">Complement</span> <span class="ow">=</span> <span class="kt">Rotate</span>
<a name="line-105"></a>
<a name="line-106"></a><span class="c1">-- Finally, the actual behavior of the circuit</span>
<a name="line-107"></a><span class="nf">blinkerT</span> <span class="ow">::</span>
<a name="line-108"></a>  <span class="p">(</span><span class="kt">BitVector</span> <span class="mi">8</span><span class="p">,</span> <span class="kt">LedMode</span><span class="p">,</span> <span class="kt">Index</span> <span class="mi">6660001</span><span class="p">)</span> <span class="ow">-&gt;</span>
<a name="line-109"></a>  <span class="kt">Bool</span> <span class="ow">-&gt;</span>
<a name="line-110"></a>  <span class="p">((</span><span class="kt">BitVector</span> <span class="mi">8</span><span class="p">,</span> <span class="kt">LedMode</span><span class="p">,</span> <span class="kt">Index</span> <span class="mi">6660001</span><span class="p">),</span> <span class="kt">BitVector</span> <span class="mi">8</span><span class="p">)</span>
<a name="line-111"></a><span class="nf">blinkerT</span> <span class="p">(</span><span class="n">leds</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">cntr</span><span class="p">)</span> <span class="n">key1R</span> <span class="ow">=</span> <span class="p">((</span><span class="n">ledsN</span><span class="p">,</span> <span class="n">modeN</span><span class="p">,</span> <span class="n">cntrN</span><span class="p">),</span> <span class="n">leds</span><span class="p">)</span>
<a name="line-112"></a>  <span class="kr">where</span>
<a name="line-113"></a>    <span class="c1">-- clock frequency = 20e6  (20 MHz)</span>
<a name="line-114"></a>    <span class="c1">-- led update rate = 333e-3 (every 333ms)</span>
<a name="line-115"></a>    <span class="n">cnt_max</span> <span class="ow">=</span> <span class="mi">6660000</span> <span class="ow">::</span> <span class="kt">Index</span> <span class="mi">6660001</span> <span class="c1">-- 20e6 * 333e-3</span>
<a name="line-116"></a>
<a name="line-117"></a>    <span class="n">cntrN</span> <span class="o">|</span> <span class="n">cntr</span> <span class="o">==</span> <span class="n">cnt_max</span> <span class="ow">=</span> <span class="mi">0</span>
<a name="line-118"></a>          <span class="o">|</span> <span class="n">otherwise</span>       <span class="ow">=</span> <span class="n">cntr</span> <span class="o">+</span> <span class="mi">1</span>
<a name="line-119"></a>
<a name="line-120"></a>    <span class="n">modeN</span> <span class="o">|</span> <span class="n">key1R</span>     <span class="ow">=</span> <span class="n">flipMode</span> <span class="n">mode</span>
<a name="line-121"></a>          <span class="o">|</span> <span class="n">otherwise</span> <span class="ow">=</span> <span class="n">mode</span>
<a name="line-122"></a>
<a name="line-123"></a>    <span class="n">ledsN</span> <span class="o">|</span> <span class="n">cntr</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">=</span>
<a name="line-124"></a>              <span class="kr">case</span> <span class="n">mode</span> <span class="kr">of</span>
<a name="line-125"></a>                <span class="kt">Rotate</span> <span class="ow">-&gt;</span> <span class="n">rotateL</span> <span class="n">leds</span> <span class="mi">1</span>
<a name="line-126"></a>                <span class="kt">Complement</span> <span class="ow">-&gt;</span> <span class="n">complement</span> <span class="n">leds</span>
<a name="line-127"></a>          <span class="o">|</span> <span class="n">otherwise</span> <span class="ow">=</span> <span class="n">leds</span>
</pre></div>
<p>The two things that we wanted to highlight from the "setup" part of the descriptions are:</p>

<ul>
  <li>the <a href="https://hackage.haskell.org/package/clash-prelude/docs/Clash-Annotations-TopEntity.html"><code>Synthesize</code></a> ANN pragma, and</li>
  <li>the <a href="http://hackage.haskell.org/package/clash-prelude/docs/Clash-Annotations-SynthesisAttributes.html"><code>Annotate</code></a> synthesis attributes.</li>
</ul>

<p>The <code>Synthesize</code> annotation we see on <a href="#line-15">line 15</a>:</p>

<div class="codehilite"><pre><span></span><a name="line-1"></a><span class="cm">{-# ANN topEntity</span>
<a name="line-2"></a><span class="cm">  (Synthesize</span>
<a name="line-3"></a><span class="cm">    { t_name   = &quot;blinker&quot;</span>
<a name="line-4"></a><span class="cm">    , t_inputs = [ PortName &quot;CLOCK_50&quot;</span>
<a name="line-5"></a><span class="cm">                 , PortName &quot;KEY0&quot;</span>
<a name="line-6"></a><span class="cm">                 , PortName &quot;KEY1&quot;</span>
<a name="line-7"></a><span class="cm">                 ]</span>
<a name="line-8"></a><span class="cm">    , t_output = PortName &quot;LED&quot;</span>
<a name="line-9"></a><span class="cm">    }) #-}</span>
</pre></div>
<p>lets you control the port names of the generated <code>entity</code> (VHDL) or <code>module</code> (Verilog), and the name of the <code>entity</code>/<code>module</code> itself.
It also tells the Clash compiler from which function it should start synthesis.
So in the above case, the compiler should start from the <code>topEnity</code> function, and should call the generated <code>entity</code> corresponding to that function: <code>blinker</code>.
Then the ports corresponding to the arguments <code>clk50MHz</code>, <code>rstBtn</code> and <code>modeBtn</code> should be called: <code>CLOCK_50</code>, <code>KEY0</code> and <code>KEY1</code>.
The output port, corresponding to the result of the function should be named: <code>LED</code>.</p>

<p>Next up are the <code>Annotate</code> attributes, such as the one on <a href="#line-30">line 30</a>:</p>

<div class="codehilite"><pre><span></span><a name="line-1"></a>  <span class="kt">Clock</span> <span class="kt">Input</span>
<a name="line-2"></a>    <span class="p">`</span><span class="kt">Annotate</span><span class="p">`</span> <span class="kt">&#39;StringAttr</span> <span class="s">&quot;chip_pin&quot;</span> <span class="s">&quot;R8&quot;</span>
<a name="line-3"></a>    <span class="p">`</span><span class="kt">Annotate</span><span class="p">`</span> <span class="kt">&#39;StringAttr</span>
<a name="line-4"></a>                <span class="s">&quot;altera_attribute&quot;</span> <span class="s">&quot;-name IO_STANDARD </span><span class="se">\&quot;</span><span class="s">3.3-V LVTTL</span><span class="se">\&quot;</span><span class="s">&quot;</span> <span class="ow">-&gt;</span>
</pre></div>
<p>where we annotate the <em>type</em> <code>Clock Input</code> with two string attributes:</p>

<ul>
  <li><code>"chip_pin" "R8"</code>, which informs Quartus to connect the port corresponding to this argument to the FPGA pin called <code>R8</code>.</li>
  <li><code>"altera_attribute" "-name IO_STANDARD \"3.3-V LVTTL\""</code>, which informs Quartus about the voltage characteristics of the pin associated with the port associated with this argument.</li>
</ul>

<p>All of this allows us to simply import the generated VHDL later on in our quartus project without having to do any further FPGA configuration.</p>

<h3 id="vhdl-generation">VHDL generation</h3>

<p>Now it's time to generate some VHDL.
Copy the above description into a file called <code>Blinker.hs</code>.
Then from the command line, run the Clash compiler to generate VHDL:</p>

<p><code>clash --vhdl -fclash-hdlsyn Quartus Blinker.hs</code></p>

<p>This will create a <code>./vhdl/Blinker/blinker</code> directory with all the generated files.
Note the we passed in the additional flag <code>-fclash-hdlsyn Quartus</code>, that is because Quartus is somewhat quirky as to where it expects <code>attributes</code> for <code>entity ports</code>: in the <code>architecture</code>.
By passing <code>-fclash-hdlsyn Quartus</code>, we ensure that Clash generates VHDL that is "compliant" with these quirks.</p>

<p>You can inspect <code>./vhdl/Blinker/blinker/blinker.hs</code> and the entity and its ports are named as specified in the <code>Synthesize</code> ANN pragma.</p>

<div class="codehilite"><pre><span></span><a name="line-1"></a><span class="k">entity</span> <span class="nc">blinker</span> <span class="k">is</span>
<a name="line-2"></a>  <span class="k">port</span><span class="p">(</span><span class="c1">-- clock</span>
<a name="line-3"></a>       <span class="n">CLOCK_50</span> <span class="o">:</span> <span class="k">in</span> <span class="n">blinker_types</span><span class="p">.</span><span class="n">clk_input</span><span class="p">;</span>
<a name="line-4"></a>       <span class="n">KEY0</span>     <span class="o">:</span> <span class="k">in</span> <span class="kt">boolean</span><span class="p">;</span>
<a name="line-5"></a>       <span class="n">KEY1</span>     <span class="o">:</span> <span class="k">in</span> <span class="kt">std_logic</span><span class="p">;</span>
<a name="line-6"></a>       <span class="n">LED</span>      <span class="o">:</span> <span class="k">out</span> <span class="kt">std_logic_vector</span><span class="p">(</span><span class="mi">7</span> <span class="k">downto</span> <span class="mi">0</span><span class="p">));</span>
<a name="line-7"></a><span class="k">end</span><span class="p">;</span>
</pre></div>
<p>Further down, we can see that the synthesis attributes have propagated to the generated VHDL:</p>

<div class="codehilite"><pre><span></span><a name="line-1"></a><span class="k">attribute</span> <span class="n">altera_attribute</span> <span class="o">:</span> <span class="kt">string</span><span class="p">;</span>
<a name="line-2"></a><span class="k">attribute</span> <span class="n">altera_attribute</span> <span class="k">of</span> <span class="n">LED</span> <span class="o">:</span> <span class="k">signal</span> <span class="k">is</span> <span class="s">&quot;-name IO_STANDARD &quot;&quot;3.3-V LVTTL&quot;&quot;&quot;</span><span class="p">;</span>
<a name="line-3"></a><span class="k">attribute</span> <span class="n">altera_attribute</span> <span class="k">of</span> <span class="n">KEY1</span> <span class="o">:</span> <span class="k">signal</span> <span class="k">is</span> <span class="s">&quot;-name IO_STANDARD &quot;&quot;3.3-V LVTTL&quot;&quot;&quot;</span><span class="p">;</span>
<a name="line-4"></a><span class="k">attribute</span> <span class="n">altera_attribute</span> <span class="k">of</span> <span class="n">KEY0</span> <span class="o">:</span> <span class="k">signal</span> <span class="k">is</span> <span class="s">&quot;-name IO_STANDARD &quot;&quot;3.3-V LVTTL&quot;&quot;&quot;</span><span class="p">;</span>
<a name="line-5"></a><span class="k">attribute</span> <span class="n">altera_attribute</span> <span class="k">of</span> <span class="n">CLOCK_50</span> <span class="o">:</span> <span class="k">signal</span> <span class="k">is</span> <span class="s">&quot;-name IO_STANDARD &quot;&quot;3.3-V LVTTL&quot;&quot;&quot;</span><span class="p">;</span>
<a name="line-6"></a>
<a name="line-7"></a><span class="k">attribute</span> <span class="n">chip_pin</span> <span class="o">:</span> <span class="kt">string</span><span class="p">;</span>
<a name="line-8"></a><span class="k">attribute</span> <span class="n">chip_pin</span> <span class="k">of</span> <span class="n">LED</span> <span class="o">:</span> <span class="k">signal</span> <span class="k">is</span> <span class="s">&quot;L3, B1, F3, D1, A11, B13, A13, A15&quot;</span><span class="p">;</span>
<a name="line-9"></a><span class="k">attribute</span> <span class="n">chip_pin</span> <span class="k">of</span> <span class="n">KEY1</span> <span class="o">:</span> <span class="k">signal</span> <span class="k">is</span> <span class="s">&quot;E1&quot;</span><span class="p">;</span>
<a name="line-10"></a><span class="k">attribute</span> <span class="n">chip_pin</span> <span class="k">of</span> <span class="n">KEY0</span> <span class="o">:</span> <span class="k">signal</span> <span class="k">is</span> <span class="s">&quot;J15&quot;</span><span class="p">;</span>
<a name="line-11"></a><span class="k">attribute</span> <span class="n">chip_pin</span> <span class="k">of</span> <span class="n">CLOCK_50</span> <span class="o">:</span> <span class="k">signal</span> <span class="k">is</span> <span class="s">&quot;R8&quot;</span><span class="p">;</span>
</pre></div>
<h3 id="quartus-project">Quartus Project</h3>

<p>Next up, we create a Quartus project.
We could go through the GUI to set things up, but in this case we will simply create the project manually.
Create the following files, with their given content, and put them in the directory where Clash generated the VHDL: <code>./vhdl/Blinker/blinker</code></p>

<ul>
  <li><code>blinker.sdc</code></li>
</ul>

<div class="codehilite"><pre><span></span><a name="line-1"></a><span class="nv">create_clock</span> <span class="o">-</span>name <span class="k">{</span><span class="nv">CLOCK_50</span><span class="k">}</span> <span class="o">-</span>period <span class="mf">20.000</span> <span class="o">-</span>waveform <span class="k">{</span> <span class="nv">0.000</span> <span class="mf">10.000</span> <span class="k">}</span> <span class="k">[</span><span class="nv">get_ports</span> <span class="k">{</span> <span class="nv">CLOCK_50</span> <span class="k">}]</span>
<a name="line-2"></a><span class="nv">derive_pll_clocks</span>
<a name="line-3"></a><span class="nv">derive_clock_uncertainty</span>
<a name="line-4"></a><span class="nv">set_false_path</span> <span class="o">-</span>from <span class="o">*</span> <span class="o">-</span>to <span class="k">[</span><span class="nv">get_ports</span> <span class="k">{</span><span class="nv">LED</span><span class="k">[</span><span class="o">*</span><span class="k">]}]</span>
<a name="line-5"></a><span class="nv">set_false_path</span> <span class="o">-</span>from <span class="k">[</span><span class="nv">get_ports</span> <span class="k">{</span><span class="nv">KEY0</span><span class="k">}]</span> <span class="o">-</span>to <span class="o">*</span>
<a name="line-6"></a><span class="nv">set_false_path</span> <span class="o">-</span>from <span class="k">[</span><span class="nv">get_ports</span> <span class="k">{</span><span class="nv">KEY1</span><span class="k">}]</span> <span class="o">-</span>to <span class="o">*</span>
</pre></div>
<ul>
  <li><code>blinker.qsf</code></li>
</ul>

<div class="codehilite"><pre><span></span><a name="line-1"></a><span class="nv">set_global_assignment</span> <span class="o">-</span>name DEVICE EP4CE22F17C6
<a name="line-2"></a><span class="nv">set_global_assignment</span> <span class="o">-</span>name TOP_LEVEL_ENTITY blinker
<a name="line-3"></a><span class="nv">set_global_assignment</span> <span class="o">-</span>name VHDL_FILE blinker_types.vhdl
<a name="line-4"></a><span class="nv">set_global_assignment</span> <span class="o">-</span>name VHDL_FILE blinker.vhdl
<a name="line-5"></a><span class="nv">set_global_assignment</span> <span class="o">-</span>name QSYS_FILE altpllE588ED61A4853C9C.qsys
<a name="line-6"></a><span class="nv">set_global_assignment</span> <span class="o">-</span>name SDC_FILE blinker.sdc
</pre></div>
<ul>
  <li><code>blinker.qpf</code></li>
</ul>

<div class="codehilite"><pre><span></span><a name="line-1"></a>PROJECT_REVISION = &quot;blinker&quot;
</pre></div>
<p>You should now have a directory with the following files:</p>

<ul>
  <li><code>altpllE588ED61A4853C9C.qsys</code></li>
  <li><code>blinker.qpf</code></li>
  <li><code>blinker.qsf</code></li>
  <li><code>blinker.sdc</code></li>
  <li><code>blinker.vhdl</code></li>
  <li><code>blinker_types.vhdl</code></li>
</ul>

<h3 id="fpga-bitstream-creation">FPGA Bitstream creation</h3>

<p>Now start <a href="https://fpgasoftware.intel.com/?edition=lite">Quartus Prime</a>; once started, in the menu bar, click <code>File -&gt; Open Project</code> and open <code>blinker.qpf</code>.
In the menu bar, click: <code>Processing -&gt; Start Compilation</code>.
This can take up to a minute depending on your machine.
If everything worked as it was supposed to the last messages in the logs should be in the spirit of:</p>

<div class="codehilite"><pre><span></span><a name="line-1"></a>Info (332101): Design is fully constrained for setup requirements
<a name="line-2"></a>Info (332101): Design is fully constrained for hold requirements
<a name="line-3"></a>Info: Quartus Prime Timing Analyzer was successful. 0 errors, 1 warning
<a name="line-4"></a>	Info: Peak virtual memory: 892 megabytes
<a name="line-5"></a>	Info: Processing ended: Thu Jul  9 23:52:25 2020
<a name="line-6"></a>	Info: Elapsed time: 00:00:01
<a name="line-7"></a>	Info: Total CPU time (on all processors): 00:00:01
<a name="line-8"></a>Info (293000): Quartus Prime Full Compilation was successful. 0 errors, 9 warnings
</pre></div>
<h3 id="programming-the-fpga">Programming the FPGA</h3>

<p>After synthesis has finished, it is time to program our FPGA board.
Connect the FPGA board to a USB port, and start the programmer from the menu bar: <code>Tools -&gt; Programmer</code>.
Press the <code>Start</code> button on the left to program your FPGA and wait until the progress bar says <code>100% (Successful)</code>.</p>

<p><img src="../../../../images/quartus2-programmer-blinker-f451d79b.jpg" alt="Programmer" /></p>

<p>Your FPGA should now be fully configured with the Clash generated design for you to play with.
So yeah, go press those buttons!</p>

          </div>
          <div class="w-embed">
              <div class="addthis_sharing_toolbox"></div>
            </div>
          </div>
          <div class="w-clearfix blog-author-block"><img src="../../../../images/christiaan-b33f5da1.jpg" class="blog-author-image" alt="" />
            <div class="blog-author-title">Written by</div>
            <div class="blog-author-title _2">Christiaan Baaij</div>
          </div>
          <div class="w-embed w-script">
            <div id='disqus_thread'></div>
<script type='text/javascript'>
//<![CDATA[
                  var disqus_shortname = 'qbaylogic';
          
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
//]]>
</script>
<noscript>Please enable JavaScript to view the <a href='http://disqus.com/?ref_noscript'>comments powered by Disqus.</a></noscript>
<a href='http://disqus.com' class='dsq-brlink'>comments powered by <span class='logo-disqus'>Disqus</span></a>

          </div>
        </div>
        <div class="w-col w-col-3 overall-sidebar-col-right">
          <div class="widget-block"><a href="/fpga-design.html" class="link sidebar-list-link">FPGA design</a><a href="/workshops-training.html" class="link sidebar-list-link">Workshops &amp; Training</a><a href="/clash-support.html" class="link sidebar-list-link">Clash support</a>
          </div>
          <div class="widget-block">
            <a href="/about-clash.html" class="w-inline-block widget-image-block">
              <div class="widget-image-block-overlay">
                <div class="image-block-title">About Clash</div>
                <div class="button">learn more</div>
              </div>
            </a>
          </div>
          <div class="widget-block">
            <div class="widget-content-block">
              <div class="w-clearfix content-info-block"><img src="../../../../images/location-pin-42237a1d.svg" class="contact-icon" alt="" />
                <div class="contact-block-title">Visit us</div>
                <p class="contact-info-text">Institutenweg 25A
                  <br>7521 PH Enschede
                  <br>The Netherlands</p>
              </div>
              <div class="w-clearfix content-info-block"><img src="../../../../images/telephone-handle-silhouette-2f25d8f5.svg" class="contact-icon" alt="" />
                <div class="contact-block-title">Call us</div>
                <p class="contact-info-text">Call us on <a href="tel:+31858000380" class="link">+31&nbsp;(0)85&nbsp;8000&nbsp;380</a>
                </p>
              </div>
              <div class="w-clearfix content-info-block last"><img src="../../../../images/email-filled-closed-envelope-0e8ca69e.svg" class="contact-icon" alt="" />
                <div class="contact-block-title">Mail us</div>
                <p class="contact-info-text">Mail us on <a class="link" href="mailto:info@qbaylogic.com">info@qbaylogic.com</a>
                </p>
              </div>
            </div>
          </div>
          <div class="widget-block">
            <div class="widget-content-block">
              <ul class="w-list-unstyled icon-list">
                <li class="icon-list-item smaller"><img src="../../../../images/computer-microprocessor-2-a05bac1b.svg" class="list-icon small" alt="" />
                  <div class="list-title">FPGA design house</div>
                  <p>We apply FPGA technology in domains with difficult mathematical problems, where solutions need low latencies and high performance.</p>
                </li>
                <li class="icon-list-item smaller"><img src="../../../../images/mathematic-operations-buttons-c1ed5c5c.svg" class="list-icon small" alt="" />
                  <div class="list-title">Creators of Clash</div>
                  <p>We have developed Clash, a functional hardware description language, providing unprecedented abstraction mechanisms for FPGA design.</p>
                </li>
                <li class="icon-list-item smaller last"><img src="../../../../images/teacher-26918785.svg" class="list-icon small" alt="" />
                  <div class="list-title">Experienced educators</div>
                  <p>Our workshops and training are based on 30+ years of experience in teaching students at bachelor, master, and phd level.</p>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5735ce1812343b0e"></script>


  <div class="w-section footer">
    <div class="footer-overlay">
      <div class="w-container container">
        <div class="w-row footer-row">
          <div class="w-col w-col-3 home-intro-column">
            <div class="footer-title">About us</div>
            <p><strong>QBayLogic B.V.</strong>
              <br>Institutenweg 25A
              <br>7521 PH Enschede
              <br>
              <br>KvK: 66440483
              <br>VAT: NL856554558B01</p>
          </div>
          <div class="w-col w-col-3 home-intro-column">
            <div class="footer-title">Contact us</div>
            <ul class="w-list-unstyled footer-list">
              <li class="footer-list-item">
                <p><strong>Postal address:<br></strong>QBayLogic B.V.
                  <br>Institutenweg 25A
                  <br>7521 PH Enschede</p>
              </li>
              <li class="footer-list-item"><a href="tel:+31858000380" class="link footer-link">+31 (0)85 8000 380</a>
              </li>
              <li class="footer-list-item"><a href="mailto:info@qbaylogic.com" class="link footer-link">info@qbaylogic.com</a>
              </li>
            </ul>
          </div>
          <div class="w-col w-col-3 home-intro-column">
            <div class="footer-title">Useful links</div>
            <ul class="w-list-unstyled footer-list">
              <li class="footer-list-item"><a href="/about-clash.html" class="link footer-link">About Clash</a>
              </li>
              <li class="footer-list-item"><a href="/our-team.html" class="link footer-link">Our team</a>
              </li>
              <li class="footer-list-item"><a href="/services-overview.html" class="link footer-link">Our services</a>
              </li>
              <li class="footer-list-item"><a href="/blog.html" class="link footer-link">Blog Archive</a>
              </li>
              <li class="footer-list-item"><a href="/contact-us.html" class="link footer-link">Contact us</a>
              </li>
            </ul>
          </div>
          <div class="w-col w-col-3 home-intro-column">
            <div class="footer-title">Services</div>
            <ul class="w-list-unstyled footer-list">
              <li class="footer-list-item"><a href="/fpga-design.html" class="link footer-link">FPGA design</a>
              </li>
              <li class="footer-list-item"><a href="/workshops-training.html" class="link footer-link">Workshops &amp; Training</a>
              </li>
              <li class="footer-list-item"><a href="/clash-support.html" class="link footer-link">Clash support</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
<script src="../../../../javascripts/webflow-6eade1f3.js"></script>
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-77540661-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
