<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>CλaSH FPGA Starter</title>
  <meta property="og:title" content="QBayLogic">
  <meta property="og:description" content="QBayLogic is a spin-off company of the University of Twente, Enschede, The Netherlands. We apply FPGA technology in domains with difficult mathematical problems.">
  <meta name="twitter:card" content="summary">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="../../../../stylesheets/site-393324d2.css" rel="stylesheet" />
  <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.4.7/webfont.js"></script>
  <script>
    WebFont.load({
      google: {
        families: ["Lato:100,100italic,300,300italic,400,400italic,700,700italic,900,900italic","Montserrat:400,700","Cardo:regular,italic,700","Reenie Beanie:regular"]
      }
    });
  </script>
  <script src="../../../../javascripts/modernizr-05933cc1.js"></script>
  <link rel="shortcut icon" type="image/x-icon" href="../../../../images/logo_ico_small-ba7e953f.png">
  <link rel="apple-touch-icon" href="../../../../images/Logo-389f0112.png">
</head>
<body>
  <div class="w-section header-wrapper">
    <div class="top-header">
      <div class="w-container container">
        <div class="top-nav-content-block social">
          <a href="http://www.facebook.com/qbaylogic" target="_blank" class="w-inline-block top-social-block"><img src="../../../../images/facebook_white-61c83ff3.svg" class="top-social-icon" alt="Facebook white" />
          </a>
          <a href="http://www.twitter.com/qbaylogic" target="_blank" class="w-inline-block top-social-block"><img src="../../../../images/twitter_white-2b2bd36d.svg" class="top-social-icon" alt="Twitter white" />
          </a>
          <a href="http://www.linkedin.com/company/qbaylogic" target="_blank" class="w-inline-block top-social-block"><img src="../../../../images/linkedin-logo_white-c0d672b6.svg" class="top-social-icon" alt="Linkedin logo white" />
          </a>
        </div>
        <div class="top-nav-content-block">
          <a href="http://qbaylogic.com" class="w-inline-block w-clearfix"><img src="../../../../images/gb-5afd0a44.png" class="top-nav-icon" alt="Gb" />
          </a>
          <a href="http://qbaylogic.nl" class="w-inline-block w-clearfix"><img src="../../../../images/nl-5f381ef4.png" class="top-nav-icon" alt="Nl" />
          </a>
        </div>
        <div class="w-hidden-small w-hidden-tiny top-nav-content-block left">
          <div class="header-contact-text">We are FPGA engineers located in Enschede, The Netherlands.</div>
        </div>
      </div>
    </div>
    <div class="contact-header">
      <div class="w-container container">
        <a href="/index.html" class="w-nav-brand logo-container"><img src="../../../../images/Logo-109_new-ok-e0a01a25.png" class="logo" alt="Logo 109 new ok" />
        </a>
        <div class="w-clearfix w-hidden-small w-hidden-tiny header-contact-block"><img src="../../../../images/phone-auricular-outline_grey-93d2e4ef.svg" class="header-contact-icon" alt="Phone auricular outline grey" />
          <div class="header-contact-title">Call us on:</div>
          <div class="header-contact-title _2"><a wf-temp-elem="" class="link header-contact-link" href="tel:+31858000380">+31 (0)85 8000 380</a>
          </div>
        </div>
        <div class="w-clearfix w-hidden-small w-hidden-tiny header-contact-block"><img src="../../../../images/email-envelope-outline_grey-1b7eac57.svg" class="header-contact-icon" alt="Email envelope outline grey" />
          <div class="w-hidden-small w-hidden-tiny header-contact-title">Questions?</div>
          <div class="header-contact-title _2"><a class="link header-contact-link" href="mailto:info@qbaylogic.com">Send us an e-mail</a>
          </div>
        </div>
      </div>
    </div>
    <div data-collapse="small" data-animation="default" data-duration="400" data-contain="1" class="w-nav navbar">
      <div class="w-container nav-container">
        <nav role="navigation" class="w-nav-menu nav-menu"><a href="/" class="w-nav-link nav-link">Home</a>
          <div data-delay="400" class="w-dropdown dropdown-link">
            <div class="w-dropdown-toggle nav-link dropdown">
              <div>Our services</div>
              <div class="w-icon-dropdown-toggle dropdown-icon"></div>
            </div>
            <nav data-ix="dropdown-list" class="w-dropdown-list dropdown-list"><a href="/fpga-design.html" class="w-dropdown-link dropdown-link-item">FPGA design</a><a href="/workshops-training.html" class="w-dropdown-link dropdown-link-item">Workshops &amp; Training</a><a href="/clash-support.html" class="w-dropdown-link dropdown-link-item">CλaSH support</a>
            </nav>
          </div>
          <div data-delay="200" class="w-dropdown dropdown-link">
            <div class="w-dropdown-toggle nav-link dropdown">
              <div>About us</div>
              <div class="w-icon-dropdown-toggle dropdown-icon"></div>
            </div>
            <nav data-ix="dropdown-list" class="w-dropdown-list dropdown-list"><a href="/about-clash.html" class="w-dropdown-link dropdown-link-item">About CλaSH</a><a href="/our-team.html" class="w-dropdown-link dropdown-link-item">Our team</a>
            </nav>
          </div><a href="/blog.html" class="w-nav-link nav-link">Blog archive</a><a href="/testimonials.html" class="w-nav-link nav-link">CLash&nbsp;Testimonials</a><a href="/contact-us.html" class="w-nav-link nav-link">Contact us</a>
        </nav>
        <div class="w-nav-button menu-button">
          <div class="w-icon-nav-menu"></div>
        </div>
      </div>
    </div>
  </div>


  <div class="w-section section tint">
  <div class="w-container">
    <div class="w-row recent-news-row">
      <div class="w-col w-col-9 overall-content-column-left">
        <div class="blog-post">
          <div class="blog-post-header-image-block" style="background: url('../../../../images/fpga_2_400x400_orange-6fac7130.jpg'); background-size: 100% 280px "></div>
          <h1 class="blog-post-title">CλaSH FPGA Starter</h1>
          <div class="blog-post-date">May 12, 2016</div>
          <div class="w-richtext">
            <p>In this tutorial we'll be programming the Terasic <a href="http://www.terasic.com.tw/cgi-bin/page/archive.pl?Language=English&amp;CategoryNo=165&amp;No=593&amp;PartNo=1">DE0-Nano</a> FPGA development board using the functional hardware description language <a href="http://www.clash-lang.org">CλaSH</a>.
The end result of this tutorial is demonstrated in the video below:</p>

<figure class="w-richtext-align-fullwidth" style="padding-bottom: 56.2061%; width: 100%; max-width: 100%;" data-rt-max-width="" data-rt-max-height="56.206088992974244%" data-page-url="https://youtu.be/XUj9cewMsww" data-rt-type="video" data-rt-dimensions="854:480" data-rt-align="fullwidth">
<div>
  <iframe src="https://www.youtube.com/embed/XUj9cewMsww" frameborder="0" scrolling="no" allowfullscreen=""></iframe>
</div>&nbsp;</figure>

<p>This tutorial is not a general introduction to CλaSH, nor to programming FPGAs.
It is meant to demonstrate how to use of <code>TopEntity</code> annotations (added in version <code>0.5.5</code> of CλaSH) to configure your CλaSH designs for an FPGA, without writing a single line of VHDL or (System)Verilog.
Even then, this tutorial is already almost too long for single blog post, but here goes:</p>

<blockquote>
  <p>This tutorial used to be specified in terms of <code>.topentity</code> files, a method which is now superseded by <code>TopEntity</code> annotions. You can still see the old version on <a href="https://github.com/christiaanb/christiaanb.github.io/blob/900228402321c8344853441aba96c71ed1db830b/_posts/2015-05-01-clash-fpga-starter.md">github</a></p>
</blockquote>

<h2 id="blinker-circuit">Blinker circuit</h2>

<p>We start with some general information about the <a href="http://www.terasic.com.tw/cgi-bin/page/archive.pl?Language=English&amp;CategoryNo=165&amp;No=593&amp;PartNo=1">DE0-Nano</a> board:</p>

<ul>
  <li>It has a 50 MHz crystal connected to a clock pin of FPGA, which we will connect to one of the <a href="https://www.altera.com/literature/ug/ug_altpll.pdf">PLL</a>s that is on the FPGA to create a <em>stable</em> 50 MHz clock signal.</li>
  <li>It has 8 green LEDs that turn <em>on</em> when we put a <code>1</code> on the FPGA pin connected to the LED.</li>
  <li>It has two buttons which are already properly <a href="http://en.wikipedia.org/wiki/Switch#Contact_bounce">debounced</a> by a Schmitt trigger. The buttons are <code>0</code> when they are pressed, and <code>1</code> when they are not.</li>
</ul>

<p>The circuit that we are making will repeatedly do one of two things:</p>

<ul>
  <li>Invert the state of the LEDs</li>
  <li>Rotate the state of the LEDs</li>
</ul>

<p>We switch between these two modes when the <code>KEY1</code> button on the board is pressed <em>and subsequently released</em>.
We reset the circuit by pressing the <code>KEY0</code> button.</p>

<h2 id="cash-circuit-specification">CλaSH circuit specification</h2>

<p>The <code>Blinker.hs</code> file given below implements the behaviour of circuit (<em>sans</em> reset behaviour) we just described.
As the clock is running at <code>50 MHz</code>, we shouldn't update the state of the LEDs every clock cycle, as they will just seem to to all be turned on all the time to the human eye.
We hence use a counter that counts up to a certain amount of clock cycles, and only update the state of the LEDs when the desired number of cycles is reached and the count is reset.</p>

<p><code>blinker.hs</code>:</p>

<div class="codehilite"><pre><span></span><a name="line-1"></a><span class="kr">module</span> <span class="nn">Blinker</span> <span class="kr">where</span>
<a name="line-2"></a>
<a name="line-3"></a><span class="kr">import</span> <span class="nn">CLaSH.Prelude</span>
<a name="line-4"></a>
<a name="line-5"></a><span class="cm">{-# ANN topEntity</span>
<a name="line-6"></a><span class="cm">  (defTop</span>
<a name="line-7"></a><span class="cm">    { t_name     = &quot;blinker&quot;</span>
<a name="line-8"></a><span class="cm">    , t_inputs   = [&quot;KEY1&quot;]</span>
<a name="line-9"></a><span class="cm">    , t_outputs  = [&quot;LED&quot;]</span>
<a name="line-10"></a><span class="cm">    , t_extraIn  = [ (&quot;CLOCK_50&quot;, 1)</span>
<a name="line-11"></a><span class="cm">                   , (&quot;KEY0&quot;    , 1)</span>
<a name="line-12"></a><span class="cm">                   ]</span>
<a name="line-13"></a><span class="cm">    , t_clocks   = [ (altpll &quot;altpll50&quot;</span>
<a name="line-14"></a><span class="cm">                             &quot;CLOCK_50(0)&quot;</span>
<a name="line-15"></a><span class="cm">                             &quot;not KEY0(0)&quot;)</span>
<a name="line-16"></a><span class="cm">                   ]</span>
<a name="line-17"></a><span class="cm">    }) #-}</span>
<a name="line-18"></a><span class="nf">topEntity</span> <span class="ow">::</span> <span class="kt">Signal</span> <span class="kt">Bit</span> <span class="ow">-&gt;</span> <span class="kt">Signal</span> <span class="p">(</span><span class="kt">BitVector</span> <span class="mi">8</span><span class="p">)</span>
<a name="line-19"></a><span class="nf">topEntity</span> <span class="n">key1</span> <span class="ow">=</span> <span class="n">leds</span>
<a name="line-20"></a>  <span class="kr">where</span>
<a name="line-21"></a>    <span class="n">key1R</span> <span class="ow">=</span> <span class="n">isRising</span> <span class="mi">1</span> <span class="n">key1</span>
<a name="line-22"></a>    <span class="n">leds</span>  <span class="ow">=</span> <span class="n">mealy</span> <span class="n">blinkerT</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="kt">False</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="n">key1R</span>
<a name="line-23"></a>
<a name="line-24"></a><span class="nf">blinkerT</span> <span class="p">(</span><span class="n">leds</span><span class="p">,</span><span class="n">mode</span><span class="p">,</span><span class="n">cntr</span><span class="p">)</span> <span class="n">key1R</span> <span class="ow">=</span> <span class="p">((</span><span class="n">leds&#39;</span><span class="p">,</span><span class="n">mode&#39;</span><span class="p">,</span><span class="n">cntr&#39;</span><span class="p">),</span><span class="n">leds</span><span class="p">)</span>
<a name="line-25"></a>  <span class="kr">where</span>
<a name="line-26"></a>    <span class="c1">-- clock frequency = 50e6   (50 MHz)</span>
<a name="line-27"></a>    <span class="c1">-- led update rate = 333e-3 (every 333ms)</span>
<a name="line-28"></a>    <span class="n">cnt_max</span> <span class="ow">=</span> <span class="mi">16650000</span> <span class="c1">-- 50e6 * 333e-3</span>
<a name="line-29"></a>
<a name="line-30"></a>    <span class="n">cntr&#39;</span> <span class="o">|</span> <span class="n">cntr</span> <span class="o">==</span> <span class="n">cnt_max</span> <span class="ow">=</span> <span class="mi">0</span>
<a name="line-31"></a>          <span class="o">|</span> <span class="n">otherwise</span>       <span class="ow">=</span> <span class="n">cntr</span> <span class="o">+</span> <span class="mi">1</span>
<a name="line-32"></a>
<a name="line-33"></a>    <span class="n">mode&#39;</span> <span class="o">|</span> <span class="n">key1R</span>     <span class="ow">=</span> <span class="n">not</span> <span class="n">mode</span>
<a name="line-34"></a>          <span class="o">|</span> <span class="n">otherwise</span> <span class="ow">=</span> <span class="n">mode</span>
<a name="line-35"></a>
<a name="line-36"></a>    <span class="n">leds&#39;</span> <span class="o">|</span> <span class="n">cntr</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">=</span> <span class="kr">if</span> <span class="n">mode</span> <span class="kr">then</span> <span class="n">complement</span> <span class="n">leds</span>
<a name="line-37"></a>                                <span class="kr">else</span> <span class="n">rotateL</span> <span class="n">leds</span> <span class="mi">1</span>
<a name="line-38"></a>          <span class="o">|</span> <span class="n">otherwise</span> <span class="ow">=</span> <span class="n">leds</span>
</pre></div>
<h2 id="topentity-annotations"><code>TopEntity</code> annotations</h2>

<p>Now that we've created our CλaSH design, it's time to move on to the important part of this tutorial, elaboration of the <code>TopEntity</code> annotation.
The <a href="https://hackage.haskell.org/package/clash-prelude/docs/CLaSH-Annotations-TopEntity.html#t:TopEntity">TopEntity</a> is a Haskell data type that guides the CλaSH compiler in generating port names and setting up clocks.
These annotations are applied using the <code>ANN</code> pragma:</p>

<p><code>{-# ANN foo (TopEntity {t_name = .., .., ..}) #-}</code></p>

<p>In our example, we extend the minimalist <a href="https://hackage.haskell.org/package/clash-prelude/docs/CLaSH-Annotations-TopEntity.html#v:defTop">defTop</a> annotation with:</p>

<ul>
  <li><code>t_name</code>: the name our component should have. In our case: <code>blinker</code></li>
  <li><code>t_inputs</code>: a list of names our inputs should have. In our case: <code>KEY1</code></li>
  <li><code>t_outputs</code>: a list of names our outputs should have. In our case: <code>LED</code></li>
  <li><code>t_extraIn</code>: a list of extra inputs that do not correspond to the arguments of our <code>topEntity</code> function.
These extra inputs are always bit vectors.
Every item in the <code>extra_in</code> list is a tuple (encoded as a 2-element list) of a name, and the number of bits for that input.
In our case we add an extra 1-bit input <code>CLOCK_50</code> which will correspond to the pin to which the 50MHz crystal is attached, and a 1-bit input <code>KEY0</code> which is the button we will use as a reset.</li>
  <li><code>t_clocks</code>: a list of clock sources.</li>
</ul>

<p>We create a single clock source by instantiating the <em>default</em> template for the Altera PPL component <a href="https://hackage.haskell.org/package/clash-prelude/docs/CLaSH-Annotations-TopEntity.html#v:altpll">altpll</a> for the Cyclone IV.
The first argument of this function is the name, the second an expression corresponding to the clock pin to connect, and the third the expression corresponding to the reset pin to connect.
So to elaborate the arguments in order:</p>

<ul>
  <li><code>name</code>: the name of the component generating our clock. In our case <code>"altpll50"</code>, an instantiated PLL component we will create later on in this tutorial.</li>
  <li><code>clock port</code>: Now, I lied a bit that we didn't have to write any VHDL or SystemVerilog.
As you can see, we connect the clock port to the expression <code>CLOCK_50(0)</code>, which is a VHDL expression.
The <code>altpll50</code>s <code>clock port</code> expects a single bit, but our <code>CLOCK_50</code> port is a 1-bit <em>vector</em>.
Hence we need to select the first (and only) bit: <code>"CLOCK_50(0)"</code>.</li>
  <li><code>reset port</code>: Again, we have to write some VHDL: <code>not KEY0(0)</code>.
Remember that our extra inputs are bit <em>vectors</em>, but the <code>reset port</code> expects a single bit.
Hence we need to select the first (and only) bit: <code>KEY0(0)</code>.
Additionally, remember that the keys are <code>0</code> when they are pressed, but the reset port expects an <em>active-high</em> signal.
Hence we need to negate the signal: <code>"not KEY0(0)"</code>.</li>
</ul>

<h2 id="vhdl-generation">VHDL generation</h2>

<p>Now it's time to generate some VHDL, yay!
Make sure that the <code>Blinker.hs</code> file is in your current working directory, and then run the CλaSH compiler to generate VHDL:</p>

<p><code>clash --vhdl Blinker.hs</code></p>

<p>This will create a <code>./vhdl/Blinker/</code> directory, of which, for this tutorial, the most interesting file is within that directory is:</p>

<p><code>blinker.vhdl</code>:</p>

<div class="codehilite"><pre><span></span><a name="line-1"></a><span class="c1">-- Automatically generated VHDL</span>
<a name="line-2"></a><span class="k">library</span> <span class="nn">IEEE</span><span class="p">;</span>
<a name="line-3"></a><span class="k">use</span> <span class="nn">IEEE.STD_LOGIC_1164.</span><span class="k">ALL</span><span class="p">;</span>
<a name="line-4"></a><span class="k">use</span> <span class="nn">IEEE.NUMERIC_STD.</span><span class="k">ALL</span><span class="p">;</span>
<a name="line-5"></a><span class="k">use</span> <span class="nn">IEEE.MATH_REAL.</span><span class="k">ALL</span><span class="p">;</span>
<a name="line-6"></a><span class="k">use</span> <span class="nn">work.</span><span class="k">all</span><span class="p">;</span>
<a name="line-7"></a><span class="k">use</span> <span class="nn">work.types.</span><span class="k">all</span><span class="p">;</span>
<a name="line-8"></a>
<a name="line-9"></a><span class="k">entity</span> <span class="nc">blinker</span> <span class="k">is</span>
<a name="line-10"></a>  <span class="k">port</span><span class="p">(</span><span class="n">KEY1</span>     <span class="o">:</span> <span class="k">in</span> <span class="kt">std_logic_vector</span><span class="p">(</span><span class="mi">0</span> <span class="k">downto</span> <span class="mi">0</span><span class="p">);</span>
<a name="line-11"></a>       <span class="n">CLOCK_50</span> <span class="o">:</span> <span class="k">in</span> <span class="kt">std_logic_vector</span><span class="p">(</span><span class="mi">0</span> <span class="k">downto</span> <span class="mi">0</span><span class="p">);</span>
<a name="line-12"></a>       <span class="n">KEY0</span>     <span class="o">:</span> <span class="k">in</span> <span class="kt">std_logic_vector</span><span class="p">(</span><span class="mi">0</span> <span class="k">downto</span> <span class="mi">0</span><span class="p">);</span>
<a name="line-13"></a>       <span class="n">LED</span>      <span class="o">:</span> <span class="k">out</span> <span class="kt">std_logic_vector</span><span class="p">(</span><span class="mi">7</span> <span class="k">downto</span> <span class="mi">0</span><span class="p">));</span>
<a name="line-14"></a><span class="k">end</span><span class="p">;</span>
<a name="line-15"></a>
<a name="line-16"></a><span class="k">architecture</span> <span class="nc">structural</span> <span class="k">of</span> <span class="nc">blinker</span> <span class="k">is</span>
<a name="line-17"></a>  <span class="k">signal</span> <span class="n">system1000</span>      <span class="o">:</span> <span class="kt">std_logic</span><span class="p">;</span>
<a name="line-18"></a>  <span class="k">signal</span> <span class="n">system1000_rstn</span> <span class="o">:</span> <span class="kt">std_logic</span><span class="p">;</span>
<a name="line-19"></a>  <span class="k">signal</span> <span class="n">altpll50_locked</span> <span class="o">:</span> <span class="kt">std_logic</span><span class="p">;</span>
<a name="line-20"></a><span class="k">begin</span>
<a name="line-21"></a>  <span class="n">altpll50_inst</span> <span class="o">:</span> <span class="k">entity</span> <span class="nc">altpll50</span>
<a name="line-22"></a>    <span class="k">port</span> <span class="k">map</span>
<a name="line-23"></a>      <span class="p">(</span><span class="n">inclk0</span> <span class="o">=&gt;</span> <span class="n">CLOCK_50</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a name="line-24"></a>      <span class="p">,</span><span class="n">c0</span>     <span class="o">=&gt;</span> <span class="n">system1000</span>
<a name="line-25"></a>      <span class="p">,</span><span class="n">areset</span> <span class="o">=&gt;</span> <span class="k">not</span> <span class="n">KEY0</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a name="line-26"></a>      <span class="p">,</span><span class="n">locked</span> <span class="o">=&gt;</span> <span class="n">altpll50_locked</span><span class="p">);</span>
<a name="line-27"></a>
<a name="line-28"></a>  <span class="c1">-- reset system1000_rstn is asynchronously asserted,</span>
<a name="line-29"></a>  <span class="c1">-- but synchronously de-asserted</span>
<a name="line-30"></a>  <span class="n">resetSync_n_0</span> <span class="o">:</span> <span class="k">block</span>
<a name="line-31"></a>    <span class="k">signal</span> <span class="n">n_1</span> <span class="o">:</span> <span class="kt">std_logic</span><span class="p">;</span>
<a name="line-32"></a>    <span class="k">signal</span> <span class="n">n_2</span> <span class="o">:</span> <span class="kt">std_logic</span><span class="p">;</span>
<a name="line-33"></a>  <span class="k">begin</span>
<a name="line-34"></a>    <span class="k">process</span><span class="p">(</span><span class="n">system1000</span><span class="p">,</span><span class="n">altpll50_locked</span><span class="p">)</span>
<a name="line-35"></a>    <span class="k">begin</span>
<a name="line-36"></a>      <span class="k">if</span> <span class="n">altpll50_locked</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span> <span class="k">then</span>
<a name="line-37"></a>        <span class="n">n_1</span> <span class="o">&lt;=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
<a name="line-38"></a>        <span class="n">n_2</span> <span class="o">&lt;=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
<a name="line-39"></a>      <span class="k">elsif</span> <span class="n">rising_edge</span><span class="p">(</span><span class="n">system1000</span><span class="p">)</span> <span class="k">then</span>
<a name="line-40"></a>        <span class="n">n_1</span> <span class="o">&lt;=</span> <span class="sc">&#39;1&#39;</span><span class="p">;</span>
<a name="line-41"></a>        <span class="n">n_2</span> <span class="o">&lt;=</span> <span class="n">n_1</span><span class="p">;</span>
<a name="line-42"></a>      <span class="k">end</span> <span class="k">if</span><span class="p">;</span>
<a name="line-43"></a>    <span class="k">end</span> <span class="k">process</span><span class="p">;</span>
<a name="line-44"></a>
<a name="line-45"></a>    <span class="n">system1000_rstn</span> <span class="o">&lt;=</span> <span class="n">n_2</span><span class="p">;</span>
<a name="line-46"></a>  <span class="k">end</span> <span class="k">block</span><span class="p">;</span>
<a name="line-47"></a>
<a name="line-48"></a>  <span class="n">topEntity_0_inst</span> <span class="o">:</span> <span class="k">entity</span> <span class="nc">topEntity_0</span>
<a name="line-49"></a>    <span class="k">port</span> <span class="k">map</span>
<a name="line-50"></a>      <span class="p">(</span><span class="n">key1_i1</span>         <span class="o">=&gt;</span> <span class="n">KEY1</span>
<a name="line-51"></a>      <span class="p">,</span><span class="n">system1000</span>      <span class="o">=&gt;</span> <span class="n">system1000</span>
<a name="line-52"></a>      <span class="p">,</span><span class="n">system1000_rstn</span> <span class="o">=&gt;</span> <span class="n">system1000_rstn</span>
<a name="line-53"></a>      <span class="p">,</span><span class="n">topLet_o</span>        <span class="o">=&gt;</span> <span class="n">LED</span><span class="p">);</span>
<a name="line-54"></a><span class="k">end</span><span class="p">;</span>
</pre></div>
<h2 id="portpin-mappings">Port/Pin mappings.</h2>

<p>It's almost time to start programming our FPGA.
But first we need to setup how the component ports are connected to the right pins on the FPGA.
For this we will use the <code>DE0_Nano_SystemBuilder</code> which you can find on the <a href="http://www.terasic.com.tw/cgi-bin/page/archive.pl?Language=English&amp;CategoryNo=165&amp;No=593&amp;PartNo=4">DE0-Nano CD-ROM</a>.
This will create both a pin/port map file, and a <a href="http://dl.altera.com/?edition=web">Quartus II</a> project file.
Note that I work on OS X, so both <code>DE0_Nano_SystemBuilder</code> and <code>Quartus II</code> are running inside a <a href="https://www.virtualbox.org/">VirtualBox</a> VM running Windows 8.</p>

<p><img src="../../../../images/DE0-NanoSystemBuilder-e182d333.jpg" alt="SystemBuilder" /></p>

<p>In <code>DE0_Nano_SystemBuilder</code>, call the project <code>blinker</code>, and ensure that <em>only</em> <code>CLOCK</code>, <code>Button x 2</code>, and <code>LED x 8</code> are selected.
Then press the <code>Generate</code> button, this will open a <code>save</code> dialog window: select a location where you want to create the project and hit the <code>save</code> button.
You can now close <code>DE0_Nano_SystemBuilder</code>.</p>

<p>In the directory to which you saved the project you will find the files:</p>

<ul>
  <li><code>blinker.htm</code></li>
  <li><code>blinker.qpf</code></li>
  <li><code>blinker.qsf</code></li>
  <li><code>blinker.sdc</code></li>
  <li><code>blinker.v</code></li>
</ul>

<p>You can delete <code>blinker.v</code> as we will be using our <code>blinker.vhdl</code>.
The port/pin mappings that are generated by <code>DE0_Nano_SystemBuilder</code> do not completely correspond to our port names.
We will hence need to update the mapping file <code>blinker.qsf</code>:</p>

<ul>
  <li>Replace every occurrence of <code>CLOCK_50</code> by <code>CLOCK_50[0]</code></li>
  <li>Replace every occurrence of <code>KEY[0]</code> by <code>KEY0[0]</code></li>
  <li>Replace every occurrence of <code>KEY[1]</code> by <code>KEY1[0]</code></li>
</ul>

<p>The final <code>blinker.qsf</code> file will look like:</p>

<div class="codehilite"><pre><span></span><a name="line-1"></a><span class="c">#============================================================</span>
<a name="line-2"></a><span class="c"># Build by Terasic System Builder</span>
<a name="line-3"></a><span class="c">#============================================================</span>
<a name="line-4"></a>
<a name="line-5"></a><span class="nv">set_global_assignment</span> <span class="o">-</span>name FAMILY <span class="s2">&quot;Cyclone IV E&quot;</span>
<a name="line-6"></a><span class="nv">set_global_assignment</span> <span class="o">-</span>name DEVICE EP4CE22F17C6
<a name="line-7"></a><span class="nv">set_global_assignment</span> <span class="o">-</span>name TOP_LEVEL_ENTITY <span class="s2">&quot;blinker&quot;</span>
<a name="line-8"></a><span class="nv">set_global_assignment</span> <span class="o">-</span>name ORIGINAL_QUARTUS_VERSION <span class="s2">&quot;12.0&quot;</span>
<a name="line-9"></a><span class="nv">set_global_assignment</span> <span class="o">-</span>name LAST_QUARTUS_VERSION <span class="s2">&quot;12.0&quot;</span>
<a name="line-10"></a><span class="nv">set_global_assignment</span> <span class="o">-</span>name PROJECT_CREATION_TIME_DATE <span class="s2">&quot;12:43:02 MAY 01,2015&quot;</span>
<a name="line-11"></a><span class="nv">set_global_assignment</span> <span class="o">-</span>name DEVICE_FILTER_PACKAGE FBGA
<a name="line-12"></a><span class="nv">set_global_assignment</span> <span class="o">-</span>name DEVICE_FILTER_PIN_COUNT <span class="mi">256</span>
<a name="line-13"></a><span class="nv">set_global_assignment</span> <span class="o">-</span>name DEVICE_FILTER_SPEED_GRADE <span class="mi">6</span>
<a name="line-14"></a><span class="nv">set_global_assignment</span> <span class="o">-</span>name SDC_FILE blinker.SDC
<a name="line-15"></a>
<a name="line-16"></a><span class="c">#============================================================</span>
<a name="line-17"></a><span class="c"># CLOCK</span>
<a name="line-18"></a><span class="c">#============================================================</span>
<a name="line-19"></a><span class="nv">set_location_assignment</span> PIN_R8 <span class="o">-</span>to CLOCK_50<span class="k">[</span><span class="nv">0</span><span class="k">]</span>
<a name="line-20"></a><span class="nv">set_instance_assignment</span> <span class="o">-</span>name IO_STANDARD <span class="s2">&quot;3.3-V LVTTL&quot;</span> <span class="o">-</span>to CLOCK_50<span class="k">[</span><span class="nv">0</span><span class="k">]</span>
<a name="line-21"></a>
<a name="line-22"></a><span class="c">#============================================================</span>
<a name="line-23"></a><span class="c"># LED</span>
<a name="line-24"></a><span class="c">#============================================================</span>
<a name="line-25"></a><span class="nv">set_location_assignment</span> PIN_A15 <span class="o">-</span>to LED<span class="k">[</span><span class="nv">0</span><span class="k">]</span>
<a name="line-26"></a><span class="nv">set_instance_assignment</span> <span class="o">-</span>name IO_STANDARD <span class="s2">&quot;3.3-V LVTTL&quot;</span> <span class="o">-</span>to LED<span class="k">[</span><span class="nv">0</span><span class="k">]</span>
<a name="line-27"></a><span class="nv">set_location_assignment</span> PIN_A13 <span class="o">-</span>to LED<span class="k">[</span><span class="nv">1</span><span class="k">]</span>
<a name="line-28"></a><span class="nv">set_instance_assignment</span> <span class="o">-</span>name IO_STANDARD <span class="s2">&quot;3.3-V LVTTL&quot;</span> <span class="o">-</span>to LED<span class="k">[</span><span class="nv">1</span><span class="k">]</span>
<a name="line-29"></a><span class="nv">set_location_assignment</span> PIN_B13 <span class="o">-</span>to LED<span class="k">[</span><span class="nv">2</span><span class="k">]</span>
<a name="line-30"></a><span class="nv">set_instance_assignment</span> <span class="o">-</span>name IO_STANDARD <span class="s2">&quot;3.3-V LVTTL&quot;</span> <span class="o">-</span>to LED<span class="k">[</span><span class="nv">2</span><span class="k">]</span>
<a name="line-31"></a><span class="nv">set_location_assignment</span> PIN_A11 <span class="o">-</span>to LED<span class="k">[</span><span class="nv">3</span><span class="k">]</span>
<a name="line-32"></a><span class="nv">set_instance_assignment</span> <span class="o">-</span>name IO_STANDARD <span class="s2">&quot;3.3-V LVTTL&quot;</span> <span class="o">-</span>to LED<span class="k">[</span><span class="nv">3</span><span class="k">]</span>
<a name="line-33"></a><span class="nv">set_location_assignment</span> PIN_D1 <span class="o">-</span>to LED<span class="k">[</span><span class="nv">4</span><span class="k">]</span>
<a name="line-34"></a><span class="nv">set_instance_assignment</span> <span class="o">-</span>name IO_STANDARD <span class="s2">&quot;3.3-V LVTTL&quot;</span> <span class="o">-</span>to LED<span class="k">[</span><span class="nv">4</span><span class="k">]</span>
<a name="line-35"></a><span class="nv">set_location_assignment</span> PIN_F3 <span class="o">-</span>to LED<span class="k">[</span><span class="nv">5</span><span class="k">]</span>
<a name="line-36"></a><span class="nv">set_instance_assignment</span> <span class="o">-</span>name IO_STANDARD <span class="s2">&quot;3.3-V LVTTL&quot;</span> <span class="o">-</span>to LED<span class="k">[</span><span class="nv">5</span><span class="k">]</span>
<a name="line-37"></a><span class="nv">set_location_assignment</span> PIN_B1 <span class="o">-</span>to LED<span class="k">[</span><span class="nv">6</span><span class="k">]</span>
<a name="line-38"></a><span class="nv">set_instance_assignment</span> <span class="o">-</span>name IO_STANDARD <span class="s2">&quot;3.3-V LVTTL&quot;</span> <span class="o">-</span>to LED<span class="k">[</span><span class="nv">6</span><span class="k">]</span>
<a name="line-39"></a><span class="nv">set_location_assignment</span> PIN_L3 <span class="o">-</span>to LED<span class="k">[</span><span class="nv">7</span><span class="k">]</span>
<a name="line-40"></a><span class="nv">set_instance_assignment</span> <span class="o">-</span>name IO_STANDARD <span class="s2">&quot;3.3-V LVTTL&quot;</span> <span class="o">-</span>to LED<span class="k">[</span><span class="nv">7</span><span class="k">]</span>
<a name="line-41"></a>
<a name="line-42"></a><span class="c">#============================================================</span>
<a name="line-43"></a><span class="c"># KEY</span>
<a name="line-44"></a><span class="c">#============================================================</span>
<a name="line-45"></a><span class="nv">set_location_assignment</span> PIN_J15 <span class="o">-</span>to KEY0<span class="k">[</span><span class="nv">0</span><span class="k">]</span>
<a name="line-46"></a><span class="nv">set_instance_assignment</span> <span class="o">-</span>name IO_STANDARD <span class="s2">&quot;3.3-V LVTTL&quot;</span> <span class="o">-</span>to KEY0<span class="k">[</span><span class="nv">0</span><span class="k">]</span>
<a name="line-47"></a><span class="nv">set_location_assignment</span> PIN_E1 <span class="o">-</span>to KEY1<span class="k">[</span><span class="nv">0</span><span class="k">]</span>
<a name="line-48"></a><span class="nv">set_instance_assignment</span> <span class="o">-</span>name IO_STANDARD <span class="s2">&quot;3.3-V LVTTL&quot;</span> <span class="o">-</span>to KEY1<span class="k">[</span><span class="nv">0</span><span class="k">]</span>
<a name="line-49"></a>
<a name="line-50"></a><span class="c">#============================================================</span>
<a name="line-51"></a><span class="c"># End of pin assignments by Terasic System Builder</span>
<a name="line-52"></a><span class="c">#============================================================</span>
</pre></div>
<p>Also, since we will be using the <code>PLL</code> for clocks, you can replace the entire contents of <code>blinker.sdc</code> by:</p>

<p><code>
derive_pll_clocks
</code></p>

<h2 id="quartus-ii">Quartus II</h2>

<p>We now open the <code>blinker.qpf</code> file in <code>Quartus II</code>.
For this tutorial, I will be using version <code>14.1</code> of the <code>Quartus II</code> software.
The first thing we will do is add the VHDL files generated by CλaSH to our design.
In the menu bar, go to, <code>Project -&gt; Add/Remove Files in Project...</code>, press the <code>...</code> button next to <code>File name</code>, in the load dialog, select all the files generated by clash, and press <code>Open</code>.
Then press <code>OK</code> to close the <code>Settings</code> dialog.</p>

<p><img src="../../../../images/quartus2-blinker-files-af1e9a0a.jpg" alt="BlinkerFiles" /></p>

<p>Next we will create a <code>PLL</code> component.
On the right of the <code>Quartus II</code> main window you will see the <code>IP Catalog</code>.
Go to <code>Installed IP &gt; Library &gt; Basic Functions &gt; Clocks; PLLs and Resets &gt; PLL</code>, and double click on <code>ALTPLL</code>.</p>

<p><img src="../../../../images/quartus2-ipcatalog-altpll-b99ed70f.jpg" alt="CatalogPLL" /></p>

<p>This opens a dialog called <code>Save IP Variation</code>, at the end of the line enter <code>altpll50</code> and press <code>OK</code>.</p>

<p><img src="../../../../images/quartus2-ipvariation-altpll50-2db544ca.jpg" alt="VariationPLL" /></p>

<p>This opens the <code>MegaWizard</code> dialog for the PLL.
Change <code>What is the frequency of the inclk0 input?</code> to <code>50.000</code>.</p>

<p><img src="../../../../images/megawizzard-altpll50-d197526c.jpg" alt="WizardPLL" /></p>

<p>Then press <code>Finish</code> <em>twice</em>.
This closes the <code>MegaWizard</code> dialog, and opens a new dialog asking if you want to add this IP block to your project.
We want this, so select 'Yes'.</p>

<h3 id="synthesis-time">Synthesis time</h3>

<p>Finally, we're finished with configuration, and we can start creating the configuration file for the FPGA.
In the menu bar, click: 'Processing -&gt; Start Compilation'.
In my extremely slow VM this compilation/synthesis process will take a while, if but might be much faster on your machine.</p>

<h3 id="programming-time">Programming time</h3>

<p>After synthesis has finished, it is time to program our FPGA board.
Connect the FPGA board to a USB port, and start the programmer from the menu bar: <code>Tools -&gt; Programmer</code>.
Press the <code>Start</code> button on the left to program your FPGA and wait until the progress bar says <code>100% (Successful)</code>.</p>

<p><img src="../../../../images/quartus2-programmer-blinker-f451d79b.jpg" alt="Programmer" /></p>

<h2 id="time-to-play">Time to play</h2>

<p>Your FPGA should now be fully configured with the CλaSH generated design for you to play with.
So yeah, go press those buttons!</p>

<p>This ends the tutorial on the use of <code>TopEntity</code> annotations to program your FPGA devices with CλaSH designs.
I hope you got the gist of it.
If/When I get my hands on a Xilinx FPGA board, I hope to make an alternate version of this tutorial, but then use Xilinx' ISE/Vivado tool-flow instead.</p>

          </div>
          <div class="w-embed">
              <div class="addthis_sharing_toolbox"></div>
            </div>
          </div>
          <div class="w-clearfix blog-author-block"><img src="../../../../images/christiaan-b33f5da1.jpg" class="blog-author-image" alt="Christiaan" />
            <div class="blog-author-title">Written by</div>
            <div class="blog-author-title _2">Christiaan Baaij</div>
          </div>
          <div class="w-embed w-script">
            <div id='disqus_thread'></div>
<script type='text/javascript'>
//<![CDATA[
                  var disqus_shortname = 'qbaylogic';
          
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
//]]>
</script>
<noscript>Please enable JavaScript to view the <a href='http://disqus.com/?ref_noscript'>comments powered by Disqus.</a></noscript>
<a href='http://disqus.com' class='dsq-brlink'>comments powered by <span class='logo-disqus'>Disqus</span></a>

          </div>
        </div>
        <div class="w-col w-col-3 overall-sidebar-col-right">
          <div class="widget-block"><a href="/fpga-design.html" class="link sidebar-list-link">FPGA design</a><a href="/workshops-training.html" class="link sidebar-list-link">Workshops &amp; Training</a><a href="/clash-support.html" class="link sidebar-list-link">CλaSH support</a>
          </div>
          <div class="widget-block">
            <a href="/about-clash.html" class="w-inline-block widget-image-block">
              <div class="widget-image-block-overlay">
                <div class="image-block-title">About CλaSH</div>
                <div class="button">learn more</div>
              </div>
            </a>
          </div>
          <div class="widget-block">
            <div class="widget-content-block">
              <div class="w-clearfix content-info-block"><img src="../../../../images/location-pin-42237a1d.svg" class="contact-icon" alt="Location pin" />
                <div class="contact-block-title">Visit us</div>
                <p class="contact-info-text">Institutenweg 25A
                  <br>7521 PH Enschede
                  <br>The Netherlands</p>
              </div>
              <div class="w-clearfix content-info-block"><img src="../../../../images/telephone-handle-silhouette-2f25d8f5.svg" class="contact-icon" alt="Telephone handle silhouette" />
                <div class="contact-block-title">Call us</div>
                <p class="contact-info-text">Call us on <a href="tel:+31858000380" class="link">+31&nbsp;(0)85&nbsp;8000&nbsp;380</a>
                </p>
              </div>
              <div class="w-clearfix content-info-block last"><img src="../../../../images/email-filled-closed-envelope-0e8ca69e.svg" class="contact-icon" alt="Email filled closed envelope" />
                <div class="contact-block-title">Mail us</div>
                <p class="contact-info-text">Mail us on <a class="link" href="mailto:info@qbaylogic.com">info@qbaylogic.com</a>
                </p>
              </div>
            </div>
          </div>
          <div class="widget-block">
            <div class="widget-content-block">
              <ul class="w-list-unstyled icon-list">
                <li class="icon-list-item smaller"><img src="../../../../images/computer-microprocessor-2-a05bac1b.svg" class="list-icon small" alt="Computer microprocessor 2" />
                  <div class="list-title">FPGA engineers</div>
                  <p>We apply FPGA technology in domains with difficult mathematical problems, where solutions need low latencies and high performance.</p>
                </li>
                <li class="icon-list-item smaller"><img src="../../../../images/mathematic-operations-buttons-c1ed5c5c.svg" class="list-icon small" alt="Mathematic operations buttons" />
                  <div class="list-title">Creators of CλaSH</div>
                  <p>We have developed CλaSH, a functional hardware description language, providing unprecedented abstraction mechanisms for FPGA design.</p>
                </li>
                <li class="icon-list-item smaller last"><img src="../../../../images/teacher-26918785.svg" class="list-icon small" alt="Teacher" />
                  <div class="list-title">Experienced educators</div>
                  <p>Our workshops and training are based on 30+ years of experience in teaching students at bachelor, master, and phd level.</p>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5735ce1812343b0e"></script>


  <div class="w-section footer">
    <div class="footer-overlay">
      <div class="w-container container">
        <div class="w-row footer-row">
          <div class="w-col w-col-3 home-intro-column">
            <div class="footer-title">About us</div>
            <p><strong>QBayLogic B.V.</strong>
              <br>Institutenweg 25A
              <br>7521 PH Enschede
              <br>
              <br>KvK: 66440483
              <br>VAT: NL856554558B01</p>
          </div>
          <div class="w-col w-col-3 home-intro-column">
            <div class="footer-title">Contact us</div>
            <ul class="w-list-unstyled footer-list">
              <li class="footer-list-item">
                <p><strong>Postal address:<br></strong>QBayLogic B.V.
                  <br>Institutenweg 25A
                  <br>7521 PH Enschede</p>
              </li>
              <li class="footer-list-item"><a href="tel:+31858000380" class="link footer-link">+31 (0)85 8000 380</a>
              </li>
              <li class="footer-list-item"><a href="mailto:info@qbaylogic.com" class="link footer-link">info@qbaylogic.com</a>
              </li>
            </ul>
          </div>
          <div class="w-col w-col-3 home-intro-column">
            <div class="footer-title">Useful links</div>
            <ul class="w-list-unstyled footer-list">
              <li class="footer-list-item"><a href="/about-clash.html" class="link footer-link">About CλaSH</a>
              </li>
              <li class="footer-list-item"><a href="/our-team.html" class="link footer-link">Our team</a>
              </li>
              <li class="footer-list-item"><a href="/services-overview.html" class="link footer-link">Our services</a>
              </li>
              <li class="footer-list-item"><a href="/blog.html" class="link footer-link">Blog Archive</a>
              </li>
              <li class="footer-list-item"><a href="/contact-us.html" class="link footer-link">Contact us</a>
              </li>
            </ul>
          </div>
          <div class="w-col w-col-3 home-intro-column">
            <div class="footer-title">Services</div>
            <ul class="w-list-unstyled footer-list">
              <li class="footer-list-item"><a href="/fpga-design.html" class="link footer-link">FPGA design</a>
              </li>
              <li class="footer-list-item"><a href="/workshops-training.html" class="link footer-link">Workshops &amp; Training</a>
              </li>
              <li class="footer-list-item"><a href="/clash-support.html" class="link footer-link">CλaSH support</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
<script src="../../../../javascripts/webflow-6eade1f3.js"></script>
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-77540661-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
